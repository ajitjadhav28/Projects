/* Main.c file generated by New Project wizard
 *
 * Created:   Thu Mar 3 2016
 * Processor: PIC18F46K22
 * Compiler:  MPLAB C18
 */

#include <p18F46K22.h>
#include <delays.h>
#include <stdio.h>
#include "config.h"
#include "lcd.h"
#include "adc.h"

char line1[16];
char line2[16];
unsigned int t;

void lcdinit();
void lcdstring(unsigned char *);

void msDelay(unsigned int i)
{
    for(; i>0; i--)
        Delay1KTCYx(4);
}

void usDelay(unsigned int i)
{
    for(; i>0; i--)
    {
        Nop();
        Nop();
        Nop();
        Nop();
    }
}

void main(void) {
    unsigned int i;
    short f;
    float msTime=0;
    OSCCON = 0x76;
    VREFCON1 = 0xE0;
    T0CON = 0x01;
    TRISB = 0;
    PORTB = 0xff;
    TRISAbits.TRISA4 = 0;
    TRISBbits.TRISB0 = 1;
    WPUBbits.WPUB0 = 1;
    msDelay(1000);
    lcdinit();
    lcdcmd(0x01);
    lcdcmd(0x80);
    i = 0;
    f=0;
    while(1)
    {
        
        PORTBbits.RB5 = 1;
        TMR0H = 0;
        TMR0L = 0;
        lcdcmd(0x80);
        if(i >= 0x1C)
            f = 1;
        if(i <= 17)
            f = 0; 
        VREFCON2 = i;
        sprintf(line1,"BRIGHT. LVL - %d ",i);
        lcdstring(line1);
        PORTAbits.RA4 = 1;
        Delay10TCYx(4);
        PORTAbits.RA4 = 0;
        while(!PORTBbits.RB0);
        T0CONbits.TMR0ON = 1;
        while(PORTBbits.RB0);
        T0CONbits.TMR0ON = 0;
        t = (TMR0L | (TMR0H << 8));
        lcdcmd(0xC0);
        sprintf(line2,"Time - %i",t);
        lcdstring(line2);
        if(f)
            i--;
        else
            i++;
        PORTBbits.RB5 = 0;
    }
    
}